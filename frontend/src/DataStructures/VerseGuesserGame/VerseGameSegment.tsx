import { Subscribable } from "../Global/Subscribable";
import { Verse } from "../Global/Verse";
import { getRandomVerseGameSegment } from "../../../src/AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/Middlelayer"

/**
 * This represnts a single round, where a single round is the user attempting to guess a single verse.
 */
export class VerseGameSegment extends Subscribable {
   private bibleVersion: string = "King James Version"
   private versesInBible: number = 31102;
   private guesses: number = 0;
   private contextVerseDefault: number = 5;
   /**
    * Verses that are above the verse to guess (higher global number)
    */
   private contextVersesAbove: Verse[] = [];
   /**
    * Verses that are below the verse to guess (lower global number)
    */
   private contextVersesBelow: Verse[] = [];
   private previousGuesses: Verse[] = []
   /**
    * Stores the score of every guess in this round
    */
   private guessScores: number[] = [];
   private verseToGuess: Verse | undefined;
   /**
    * Is this verse game segment busy fetching the random verses from the backend
    */
   private isLoadingVerses: boolean = false;
   /**
    * Did the fetch to the backend compelte successfully.
    */
   private errorLoadingVerses: boolean = false;
   /**
    * Did this game segment end by the user successfully guessing the verse?
    */
   private hasSuccessfullyGuessed: boolean = false;
   /**
    * The current hint count for this game segment
    */
   private hintCount: number = 0;
   /**
    * The amount of hints for each guess in the previousGuesses array.
    * 
    */
   private hintHistory: number[] = [];
   private finalRoundScore: number = 0;
   constructor(bibleVersion: string, contextVerseDefault: number) {
      super()
      this.bibleVersion = bibleVersion;
      this.contextVerseDefault = contextVerseDefault;
   }
   /**
    * Gets a random group of verses from the backend, automatically sets all of the
    * context verses.
    */
   initVerses = () => {
      getRandomVerseGameSegment(this)
   }
   /**
    * Checks if the user has already guessed this verse.
    * 
    * @param other 
    * @returns 
    */
   previousGuessesContainsVerse = (other: Verse): boolean => {
      if (other.getGlobalVerseNumber() === -1) {
         console.warn("VerseGameSegment | previousGuessesContainsVerse | Verse global number is -1: ", other)
      }
      for (let currentVerse of this.previousGuesses) {
         if (other.getGlobalVerseNumber() === currentVerse.getGlobalVerseNumber()) {
            return true;
         }
      }
      return false;
   }
   addHint = () => {
      this.hintCount += 1;
      this.emitChange()
   }
   setHasSuccessfullyGuessed = (gussed: boolean) => {
      this.hasSuccessfullyGuessed = gussed
      this.emitChange()
   }
   setErrorLoadingVerses = (errorLoadingVerses: boolean) => {
      this.errorLoadingVerses = errorLoadingVerses;
      this.emitChange();
   }
   setIsLoadingVerses = (isLoading: boolean) => {
      this.isLoadingVerses = isLoading;
      this.emitChange();
   }
   setBibleVersion = (version: string) => {
      this.bibleVersion = version
      this.emitChange()
   }
   setVerseToGuess = (verseToGuess: Verse) => {
      this.verseToGuess = verseToGuess;
      this.emitChange();
   }
   setContextVerseDefault = (context: number) => {
      this.contextVerseDefault = context;
      this.contextVersesAbove = []
      this.contextVersesBelow = []
      this.verseToGuess = undefined;
      this.emitChange();
   }
   setContextVersesAbove = (above: Verse[]) => {
      this.contextVersesAbove = [...above]
      this.emitChange();
   }
   setContextVersesBelow = (below: Verse[]) => {
      this.contextVersesBelow = [...below]
      this.emitChange();
   }
   /**
    * Adds this verse to the guessed array. Automatically updates hint history and guess count.
    * 
    * @param verseUserGuessed 
    */
   addPreviousGuess = (verseUserGuessed: Verse) => {
      if (verseUserGuessed.getGlobalVerseNumber() === -1) {
         console.warn("VerseGameSegment | addPreviousGuess | Added previous user guess but the global index is -1")
      }
      this.guesses += 1;
      this.hintHistory.push(this.hintCount);
      this.previousGuesses = [...this.previousGuesses, verseUserGuessed]
      this.emitChange()
   }
   getHintHistory = (): number[] => {
      return this.hintHistory;
   }
   getHints = (): number => {
      return this.hintCount;
   }
   getGuessScore = (): number[] => {
      return this.guessScores
   }
   getHasSuccessfullyGuessed = (): boolean => {
      return this.hasSuccessfullyGuessed;
   }
   getErrorLoadingVerses = (): boolean => {
      return this.errorLoadingVerses;
   }
   getIsLoadingVerses = (): boolean => {
      return this.isLoadingVerses;
   }
   getContextVersesDefault = (): number => {
      return this.contextVerseDefault;
   }
   getBibleVersion = (): string => {
      return this.bibleVersion;
   }
   getGuesses = (): number => {
      return this.guesses;
   }
   getContextVersesAbove = (): Verse[] => {
      return this.contextVersesAbove;
   }
   getContextVersesBelow = (): Verse[] => {
      return this.contextVersesBelow;
   }
   getVerseToGuess = (): Verse | undefined => {
      return this.verseToGuess;
   }
   getPreviousGuesses = (): Verse[] => {
      return this.previousGuesses
   }
   getFinalRoundScore = () => {
      return this.finalRoundScore;
   }
   /**
    * Calculautes the score for this round and stores it in guessScores.
    * 
    * Chooses the highest guess score and stores it in the finalRoundScore variable.
    */
   calculateScore = () => {
      if (this.guesses === 0) {
         console.log("VerseGameSegment | calculateScore | " + this.getVerseToGuess()?.getVerseIdentifier()+" round score was 0");
         this.finalRoundScore = 0;
         this.emitChange()
         return;
      }
      this.guessScores = []
      for (let i = 0; i < this.previousGuesses.length; i++) {

         var preHintScore = Math.round(
            // Actual High Score
            (this.versesInBible -
               // Reduction due to distance
               Math.abs((this.verseToGuess?.getGlobalVerseNumber() as number) - (this.previousGuesses[i].getGlobalVerseNumber()))))

         preHintScore -= (preHintScore * (1 / 3) * this.hintHistory[i])

         this.guessScores.push(Math.floor(preHintScore));
         console.log("VerseGameSegment | calculateScore | Previous guess " + this.previousGuesses[i].getVerseIdentifier() +" Scored " + this.guessScores[i]);
         console.log("VerseGameSegment | calculateScore | Previous guess Hint: "+this.hintHistory[i])
      }
      this.finalRoundScore = Math.max(...this.guessScores);
      console.log("VerseGameSegment | calculateScore | " + this.getVerseToGuess()?.getVerseIdentifier()+" round score was "+this.finalRoundScore);
      this.emitChange();
   }
}