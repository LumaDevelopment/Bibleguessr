import { BibleData } from "../Global/BibleData";
import { Subscribable } from "../Global/Subscribable";
import { Verse } from "../Global/Verse";
import { getRandomVerseGameSegment } from "../../../src/AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/../AppRoutes/Middlelayer"

/**
 * Since the user will have the ability to change the settings during a play sesson, then 
 * each time the user does a guessing segment, it will save there settings at that  point.
 * Every part of the game loop will create a new segment.
 * 
 * For example, the user can request more guesses for a  game segment, while keeping the other segments intact.
 * 
 * Every GameSegment must also be subscribable. This allows for the active game instance to keep the UI and the data structure in sync.
 */
export class VerseGameSegment extends Subscribable {
   private bibleVersion: string = "King James Version"
   private versesInBible: number = 31102;
   private guesses: number = 0;
   private contextVerseDefault: number = 5;
   /**
    * Verses that are above the verse to guess (higher global number)
    */
   private contextVersesAbove: Verse[] = [];
   /**
    * Verses that are below the verse to guess (lower global number)
    */
   private contextVersesBelow: Verse[] = [];
   private previousGuesses: Verse[] = []
   private guessScores: number[] = [];
   private verseToGuess: Verse | undefined;
   private isLoadingVerses: boolean = false;
   private errorLoadingVerses: boolean = false;
   private hasSuccessfullyGuessed: boolean = false;
   private hintCount: number = 0;
   private hintHistory: number[] = [];
   private finalRoundScore: number = 0;
   constructor(bibleVersion: string, contextVerseDefault: number) {
      super()
      this.bibleVersion = bibleVersion;
      this.contextVerseDefault = contextVerseDefault;
   }
   initVerses = () => {
      getRandomVerseGameSegment(this)
   }
   previousGuessesContainsVerse = (other: Verse): boolean => {
      if (other.getGlobalVerseNumber() === -1) {
         console.warn("VerseGameSegment | previousGuessesContainsVerse | Verse global number is -1: ", other)
      }
      for (let currentVerse of this.previousGuesses) {
         console.log("VerseGameSegment | previousGuessesContainsVerse | ", other.getGlobalVerseNumber(), currentVerse.getGlobalVerseNumber())
         if (other.getGlobalVerseNumber() === currentVerse.getGlobalVerseNumber()) {
            console.log("VerseGameSegment | previousGuessesContainsVerse | True")
            return true;
         }
      }
      console.log("VerseGameSegment | previousGuessesContainsVerse | False")
      return false;
   }
   addHint = () => {
      this.hintCount += 1;
      this.emitChange()
   }
   setHasSuccessfullyGuessed = (gussed: boolean) => {
      this.hasSuccessfullyGuessed = gussed
      this.emitChange()
   }
   setErrorLoadingVerses = (errorLoadingVerses: boolean) => {
      this.errorLoadingVerses = errorLoadingVerses;
      this.emitChange();
   }
   setIsLoadingVerses = (isLoading: boolean) => {
      this.isLoadingVerses = isLoading;
      this.emitChange();
   }
   setBibleVersion = (version: string) => {
      this.bibleVersion = version
      this.emitChange()
   }
   setVerseToGuess = (verseToGuess: Verse) => {
      this.verseToGuess = verseToGuess;
      this.emitChange();
   }
   setContextVerseDefault = (context: number) => {
      this.contextVerseDefault = context;
      this.contextVersesAbove = []
      this.contextVersesBelow = []
      this.verseToGuess = undefined;
      this.emitChange();
   }
   setContextVersesAbove = (above: Verse[]) => {
      this.contextVersesAbove = [...above]
      this.emitChange();
   }
   setContextVersesBelow = (below: Verse[]) => {
      this.contextVersesBelow = [...below]
      this.emitChange();
   }
   addPreviousGuess = (verseUserGuessed: Verse) => {
      if (verseUserGuessed.getGlobalVerseNumber() === -1) {
         console.warn("VerseGameSegment | addPreviousGuess | Added previous user guess but the global index is -1")
      }
      this.guesses += 1;
      this.hintHistory.push(this.hintCount);
      this.previousGuesses = [...this.previousGuesses, verseUserGuessed]
      this.emitChange()
   }
   getHintHistory = (): number[] => {
      return this.hintHistory;
   }
   getHints = (): number => {
      return this.hintCount;
   }
   getGuessScore = (): number[] => {
      return this.guessScores
   }
   getHasSuccessfullyGuessed = (): boolean => {
      return this.hasSuccessfullyGuessed;
   }
   getErrorLoadingVerses = (): boolean => {
      return this.errorLoadingVerses;
   }
   getIsLoadingVerses = (): boolean => {
      return this.isLoadingVerses;
   }
   getContextVersesDefault = (): number => {
      return this.contextVerseDefault;
   }
   getBibleVersion = (): string => {
      return this.bibleVersion;
   }
   getGuesses = (): number => {
      return this.guesses;
   }
   getContextVersesAbove = (): Verse[] => {
      return this.contextVersesAbove;
   }
   getContextVersesBelow = (): Verse[] => {
      return this.contextVersesBelow;
   }
   getVerseToGuess = (): Verse | undefined => {
      return this.verseToGuess;
   }
   getPreviousGuesses = (): Verse[] => {
      return this.previousGuesses
   }
   getFinalRoundScore = () => {
      return this.finalRoundScore;
   }
   calculateScore = () => {
      if (this.guesses === 0) {
         console.log("VerseGameSegment | calculateScore | " + this.getVerseToGuess()?.getVerseIdentifier()+" round score was 0");
         this.finalRoundScore = 0;
         this.emitChange()
         return;
      }
      this.guessScores = []
      for (let i = 0; i < this.previousGuesses.length; i++) {
         this.guessScores.push(Math.round(
            // Actual High Score
            (this.versesInBible -
               // Reduction due to distance
               Math.abs((this.verseToGuess?.getGlobalVerseNumber() as number) - (this.previousGuesses[i].getGlobalVerseNumber())) -
               // Reduction due to hints
               ((1 / 3) * this.hintHistory[i]))));
         console.log("VerseGameSegment | calculateScore | Previous guess " + this.previousGuesses[i].getVerseIdentifier() +" Scored " + this.guessScores[i]);
      }
      this.finalRoundScore = Math.max(...this.guessScores);
      console.log("VerseGameSegment | calculateScore | " + this.getVerseToGuess()?.getVerseIdentifier()+" round score was "+this.finalRoundScore);
      this.emitChange();
   }
}